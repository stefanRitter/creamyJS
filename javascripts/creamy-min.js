function xhrGet(d,a,c){var b=new XMLHttpRequest;b.open("GET",d,!0);c&&(b.responseType=c);b.onload=a;b.send()}Array.prototype.erase=function(d){for(var a=this.length;a--;a)this[a]===d&&this.splice(a,1);return this};Function.prototype.bind=function(d){var a=this;return function(){var c=Array.prototype.slice.call(arguments);return a.apply(d||null,c)}};
merge=function(d,a){for(var c in a){var b=a[c];if("object"!=typeof b||b instanceof Class)d[c]=b;else{if(!d[c]||"object"!=typeof d[c])d[c]={};merge(d[c],b)}}return d};function copy(d){if(!d||"object"!=typeof d||d instanceof Class)return d;if(d instanceof Array)for(var a=[],c=0,b=d.length;c<b;c++)a[c]=copy(d[c]);else for(c in a={},d)a[c]=copy(d[c]);return a}
function ksort(d){if(!d||"object"!=typeof d)return[];var a=[],c=[],b;for(b in d)a.push(b);a.sort();for(b=0;b<a.length;b++)c.push(d[a[b]]);return c}
(function(){var d=!1,a=/xyz/.test(function(){xyz})?/\bparent\b/:/.*/;this.Class=function(){};var c=function(b){var c=this.prototype,d={},f;for(f in b)"function"==typeof b[f]&&"function"==typeof c[f]&&a.test(b[f])?(d[f]=c[f],c[f]=function(a,b){return function(){var c=this.parent;this.parent=d[a];var g=b.apply(this,arguments);this.parent=c;return g}}(f,b[f])):c[f]=b[f]};this.Class.extend=function(b){function g(){if(!d){if(this.staticInstantiate){var a=this.staticInstantiate.apply(this,arguments);if(a)return a}for(var b in this)"object"==
typeof this[b]&&(this[b]=copy(this[b]));this.init&&this.init.apply(this,arguments)}return this}var e=this.prototype;d=!0;var f=new this;d=!1;for(var h in b)"function"==typeof b[h]&&"function"==typeof e[h]&&a.test(b[h])?f[h]=function(a,b){return function(){var c=this.parent;this.parent=e[a];var d=b.apply(this,arguments);this.parent=c;return d}}(h,b[h]):f[h]=b[h];g.prototype=f;g.constructor=g;g.extend=arguments.callee;g.inject=c;return g}})();
newGuid_short=function(){return(65536*(1+Math.random())|0).toString(16).substring(1).toString()};(function(){window.Vec2=Box2D.Common.Math.b2Vec2;window.BodyDef=Box2D.Dynamics.b2BodyDef;window.Body=Box2D.Dynamics.b2Body;window.FixtureDef=Box2D.Dynamics.b2FixtureDef;window.Fixture=Box2D.Dynamics.b2Fixture;window.World=Box2D.Dynamics.b2World;window.MassData=Box2D.Collision.Shapes.b2MassData;window.PolygonShape=Box2D.Collision.Shapes.b2PolygonShape;window.CircleShape=Box2D.Collision.Shapes.b2CircleShape;window.DebugDraw=Box2D.Dynamics.b2DebugDraw;window.RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef;
var d=Class.extend({gravity:new Vec2(0,9.8),stateTime:0,world:null,scale:32,setup:function(){gPhysicsEngine.world=new World(gPhysicsEngine.gravity,!0);gPhysicsEngine.addContactListener({PostSolve:function(a,c,b,d){var e=a?a.GetUserData():null,f=c?c.GetUserData():null;if(e&&e.ent&&e.ent.onTouch)e.ent.onTouch(c,b,d);if(f&&f.ent&&f.ent.onTouch)f.ent.onTouch(a,b,d)},EndContact:function(a,c){var b=a?a.GetUserData():null,d=c?c.GetUserData():null;if(b&&b.ent&&b.ent.onEndContact)b.ent.onEndContact();if(d&&
d.ent&&d.ent.onEndContact)d.ent.onEndContact()}})},update:function(a){this.stateTime+=a;this.stateTime>=1E3/60&&(this.stateTime=0,gPhysicsEngine.world.Step(1/60,8,3),gPhysicsEngine.world.ClearForces())},addContactListener:function(a){var c=new Box2D.Dynamics.b2ContactListener;a.PostSolve&&(c.PostSolve=function(b,c){a.PostSolve(b.GetFixtureA().GetBody(),b.GetFixtureB().GetBody(),c,b)});a.BeginContact&&(c.BeginContact=function(b){a.BeginContact(b.GetFixtureA().GetBody(),b.GetFixtureB().GetBody())});
a.EndContact&&(c.EndContact=function(b){a.EndContact(b.GetFixtureA().GetBody(),b.GetFixtureB().GetBody())});gPhysicsEngine.world.SetContactListener(c)},addBody:function(a){var c=new BodyDef,b=new FixtureDef,d=null;c.type="static"===a.type?Body.b2_staticBody:Body.b2_dynamicBody;c.position.x=a.x/gPhysicsEngine.scale;c.position.y=a.y/gPhysicsEngine.scale;c.userData=a.userData||null;b.density=a.density||b.density;b.friction=a.friction||b.friction;b.restitution=a.restitution||b.restitution;a.shape?b.shape=
a.shape:a.radius?b.shape=new CircleShape(a.radius/gPhysicsEngine.scale):(b.shape=new PolygonShape,b.shape.SetAsBox(a.halfWidth/gPhysicsEngine.scale,a.halfHeight/gPhysicsEngine.scale));d=gPhysicsEngine.world.CreateBody(c);d.CreateFixture(b);return d},removeBody:function(a){gPhysicsEngine.world.DestroyBody(a)},testEngine:function(){var a=new DebugDraw;a.SetSprite(gContext);a.SetDrawScale(gPhysicsEngine.scale);a.SetFillAlpha(0.3);a.SetLineThickness(1);a.SetFlags(DebugDraw.e_shapeBit|DebugDraw.e_jointBit);
gPhysicsEngine.world.SetDebugDraw(a)}});window.gPhysicsEngine=new d}).call(this);var gCachedAssets={};function loadImage(d,a){if(gCachedAssets[d])a(gCachedAssets[d]);else{var c=new Image;c.onload=function(){gCachedAssets[d]=c;a(c)};c.src=d}}
function loadAssets(d,a){for(var c={count:0,total:d.length,cb:a},b=0;b<d.length;b++)if(gCachedAssets[d[b]])onLoadedCallback(gCachedAssets[d[b]],c);else{var g=getAssetTypeFromExtension(d[b]);if(0===g){var e=new Image;e.onload=function(){onLoadedCallback(e,c)};e.src=d[b];gCachedAssets[d[b]]=e}else if(1===g){var f=document.createElement("script");f.setAttribute("type","text/javascript");f.onload=function(a){onLoadedCallback(f,c)};f.setAttribute("src",d[b]);document.getElementsByTagName("head")[0].appendChild(f);
gCachedAssets[d[b]]=f}else if(2===g){var h=d[b];xhrGet(d[b],function(){gCachedAssets[h]=this.responseText;onLoadedCallback(h,c)})}}}function onLoadedCallback(d,a){a.count++;a.count==a.total&&a.cb(d)}function getAssetTypeFromExtension(d){return-1!=d.indexOf(".jpg")||-1!=d.indexOf(".jpeg")||-1!=d.indexOf(".png")||-1!=d.indexOf(".gif")||-1!=d.indexOf(".wp")?0:-1!=d.indexOf(".json")?2:-1!=d.indexOf(".js")?1:-1};(function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame})();
(function(){var d=Class.extend({request:null,startTime:0,gameState:3,STATE:{PLAY:1,GAMEOVER:2,WIN:3},numLevels:3,currentLevel:-1,entities:[],factory:{},_deferredKill:[],loadingHTML:"",setup:function(){gContext.drawImage(gCachedAssets["images/controls.png"],0,0);gGameEngine.loadingHTML+=gLoading.innerHTML;loadAssets(["images/background.png","images/gamesprite.png","images/gamesprite.json"],function(){gInputEngine.setup();gBackground.setup("images/background.png");gGameEngine.setupSounds();gGameEngine.setupSpritesAndEntities();
gGameEngine.loadNextLevel()})},gameLoop:function(){if(gGameEngine.gameState===gGameEngine.STATE.PLAY){gGameEngine.request=requestAnimationFrame(gGameEngine.gameLoop);var a=Date.now()-gGameEngine.startTime;gGameEngine.startTime=Date.now();gGameEngine.update(a);gGameEngine.draw()}else gGameEngine.gameState===gGameEngine.STATE.GAMEOVER?(alert("game over"),cancelAnimationFrame(gGameEngine.request)):gGameEngine.gameState===gGameEngine.STATE.WIN&&(cancelAnimationFrame(gGameEngine.request),gGameEngine.loadNextLevel())},
update:function(a){gPlayer.update(a);for(var c=null,b=0;b<gGameEngine.entities.length;b++)c=gGameEngine.entities[b],c._killed?gGameEngine._deferredKill.push(c):c.update(a);for(c=0;c<gGameEngine._deferredKill.length;c++)gGameEngine._deferredKill[c].kill&&gGameEngine._deferredKill[c].kill(),gGameEngine.entities.erase(gGameEngine._deferredKill[c]);gGameEngine._deferredKill=[];gPhysicsEngine.update(a)},draw:function(){gBackground.draw();gMap.draw(gContext);var a=[],c={};gGameEngine.entities.forEach(function(b){b.isVisible&&
(-1===a.indexOf(b.zindex)&&(a.push(b.zindex),c[b.zindex]=[]),c[b.zindex].push(b))});a.sort(function(a,c){return a-c});a.forEach(function(a){c[a].forEach(function(a){a.draw()})});gPlayer.draw();gGameEngine.drawFrame()},loadNextLevel:function(){function a(){gLoading.style.visibility="hidden";gGameEngine.startTime=Date.now();gGameEngine.gameState=gGameEngine.STATE.PLAY;gGameEngine.request=requestAnimationFrame(gGameEngine.gameLoop);document.removeEventListener("keyup",a,!1)}if(gGameEngine.gameState===
gGameEngine.STATE.WIN)if(gGameEngine.gameState=0,gGameEngine.currentLevel+=1,gGameEngine.currentLevel>=gGameEngine.numLevels)gContext.drawImage(gCachedAssets["images/winner.png"],0,0);else{if(0!==gGameEngine.currentLevel){gContext.fillStyle="white";gContext.fillRect(0,0,gCanvas.width,gCanvas.height);var c=document.getElementById("levelup");c.onload=function(){c.style.display="block";setTimeout(function(){c.style.display="none";a()},3E3)};c.src="images/levelup.gif?"+(new Date).valueOf()}else setTimeout(function(){loadAssets(["images/map_tileset.png"],
function(){})},8E3);gLoading.innerHTML=gGameEngine.loadingHTML;gPhysicsEngine.setup();gGameEngine.entities=[];gGameEngine._deferredKill=[];var b="images/level"+gGameEngine.currentLevel+".json";gMap=new TILEDMapClass;gMap.load(b,function(){0===gGameEngine.currentLevel&&(gContext.drawImage(gCachedAssets["images/doneloading.png"],0,0),gGameEngine.drawFrame(),document.getElementById("logo").style.visibility="hidden");gMap.preDrawCache();gMap.createEntities();gMap.centerAt(gPlayer.pos.x,gPlayer.pos.y,
600,1E3);gLoading.innerHTML="... hit any key to start ...";0===gGameEngine.currentLevel&&document.addEventListener("keyup",a,!1)},1E3,600)}},spawnEntity:function(a){a=new gGameEngine.factory[a];gGameEngine.entities.push(a);return a},drawFrame:function(){drawSprite("blendL.png",-1,-1,30,601);drawSprite("blendR.png",971,-1,30,601)},playWorldSound:function(a,c,b){var d=gGameEngine.gMap,d=0.5*Math.max(d.viewRect.w,d.viewRect.h),e=gGameEngine.gPlayer.pos;c=Math.abs(e.x-c);b=Math.abs(e.y-b);b=Math.sqrt(c*
c+b*b)/d;1<b&&(b=1);if(!(0>b)){var f=1-b;gSM.loadAsync(a,function(a){gSM.playSound(a.path,{volume:f,looping:!1})})}},setupSounds:function(){gSM.loadAsync("sound/coin.ogg",function(){gSM.loadAsync("sound/hit.ogg",function(){gSM.playSound("sound/coin.ogg")})})},setupSpritesAndEntities:function(){var a=new SpriteSheetClass;a.setAsset("images/gamesprite.png",gCachedAssets["images/gamesprite.png"]);a.parseAtlasDefinition(gCachedAssets["images/gamesprite.json"])},createPlatform:function(a,c,b,d){gGameEngine.spawnEntity("PlatformEntity").create(a,
c,b,d,"platform.png",null)},createGoal:function(a,c){gGameEngine.spawnEntity("GoalEntity").create(a,c,380,380,"goal01.png goal02.png goal03.png goal04.png goal05.png goal06.png goal07.png goal08.png goal09.png goal10.png".split(" "),700)},createDynamicEnemy:function(a,c){gGameEngine.spawnEntity("EnemyEntity").create(a,c,139,120,"enemydynamic01.png enemydynamic02.png enemydynamic03.png enemydynamic04.png enemydynamic05.png enemydynamic06.png enemydynamic07.png".split(" "),500,!0)},createStaticEnemy:function(a,
c){gGameEngine.spawnEntity("EnemyEntity").create(a,c,300,104,"enemystatic01.png enemystatic02.png enemystatic03.png enemystatic04.png enemystatic05.png enemystatic06.png enemystatic06.png".split(" "),800,!1)}});window.gGameEngine=new d}).call(this);var fudgeVariance=128,EntityClass=Class.extend({pos:{x:0,y:0},canvaspos:{x:0,y:0},size:{x:0,y:0},halfsize:{x:0,y:0},_killed:!1,zindex:0,sprite:"",create:function(d,a,c,b,g){this.pos.x=d;this.pos.y=a;this.size.x=c;this.size.y=b;this.halfsize.x=c/2;this.halfsize.y=b/2;this.sprite=g;this.convertPosToScreen()},position:function(d,a){this.pos.x=d;this.pos.y=a},setSprite:function(d){this.sprite=d},update:function(){},convertPosToScreen:function(){this.canvaspos.x=this.pos.x-gMap.viewRect.x;this.canvaspos.y=
this.pos.y-gMap.viewRect.y},draw:function(){this.convertPosToScreen();drawSprite(this.sprite,this.canvaspos.x-this.halfsize.x,this.canvaspos.y-this.halfsize.y,this.size.x,this.size.y)},isVisible:function(){return entity.pos.x>=gMap.viewRect.x-fudgeVariance&&entity.pos.x<gMap.viewRect.x+gMap.viewRect.w+fudgeVariance&&entity.pos.y>=gMap.viewRect.y-fudgeVariance&&entity.pos.y<gMap.viewRect.y+gMap.viewRect.h+fudgeVariance?!0:!(gMap.viewRect.x>this.pos.x+this.halfsize.x||gMap.viewRect.x+gMap.viewRect.w<
this.pos.x-this.halfsize.x||gMap.viewRect.y>this.pos.y+this.halfsize.y||gMap.viewRect.y+gMap.viewRect.h<this.pos.y+this.halfsize.y)}});gGameEngine.factory.EntityClass=EntityClass;(function(){var d=Class.extend({clips:{},enabled:!0,_context:null,_mainNode:null,setup:function(){try{gSM._context=new webkitAudioContext}catch(a){console.log("Web Audio API is not supported in this browser");gSM._context=null;gSM.enabled=!1;return}gSM._mainNode=gSM._context.createGainNode(0);gSM._mainNode.connect(gSM._context.destination)},loadAsync:function(c,b){if(gSM.clips[c])return b(gSM.clips[c].s),gSM.clips[c].s;var d={s:new a,b:null,l:!1};gSM.clips[c]=d;d.s.path=c;var e=new XMLHttpRequest;
e.open("GET",c,!0);e.responseType="arraybuffer";e.onload=function(){gSM._context.decodeAudioData(e.response,function(a){gSM.clips[c].b=a;gSM.clips[c].l=!0;b(gSM.clips[c].s)},function(a){})};e.send();return d.s},togglemute:function(){if(!gSM.enabled)return!1;gSM._mainNode.gain.value=0<gSM._mainNode.gain.value?0:1},stopAll:function(){gSM._mainNode.disconnect();gSM._mainNode=gSM._context.createGainNode(0);gSM._mainNode.connect(gSM._context.destination)},playSound:function(a,b){if(!gSM.enabled)return!1;
var d=!1,e=0.2;b&&(b.looping&&(d=b.looping),b.volume&&(e=b.volume));var f=this.clips[a];if(null===f||!1===f.l)return!1;var h=null,h=gSM._context.createBufferSource();h.buffer=f.b;h.gain.value=e;h.loop=d;h.connect(gSM._mainNode);h.noteOn(0);return!0}}),a=Class.extend({play:function(a){gSM.playSound(this.path,{looping:a,volume:1})}});window.gSM=new d}).call(this);(function(){var d=Class.extend({bindings:{},actions:{},mouse:{x:0,y:0},setup:function(){gInputEngine.bind(32,"jump");gInputEngine.bind(37,"move-left");gInputEngine.bind(39,"move-right");document.addEventListener("keydown",gInputEngine.onKeyDown);document.addEventListener("keyup",gInputEngine.onKeyUp)},onMouseMove:function(a){gInputEngine.mouse.x=a.clientX;gInputEngine.mouse.y=a.clientY},onKeyDown:function(a){(a=gInputEngine.bindings[a.keyCode])&&(gInputEngine.actions[a]=!0)},onKeyUp:function(a){(a=
gInputEngine.bindings[a.keyCode])&&(gInputEngine.actions[a]=!1)},bind:function(a,c){gInputEngine.bindings[a]=c}});window.gInputEngine=new d}).call(this);var gSpriteSheets={},SpriteSheetClass=Class.extend({img:null,url:"",sprites:[],init:function(){},load:function(d){this.url=d;var a=new Image;a.src=d;this.img=a;gSpriteSheets[d]=this},setAsset:function(d,a){this.url=d;this.img=a;gSpriteSheets[d]=this},defSprite:function(d,a,c,b,g,e,f){this.sprites.push({id:d,x:a,y:c,w:b,h:g,cx:null===e?0:e,cy:null===f?0:f})},parseAtlasDefinition:function(d){d=JSON.parse(d);for(var a in d.frames){var c=d.frames[a],b=0.5*-c.frame.w,g=0.5*-c.frame.h;c.trimmed&&(g=0.5*
c.sourceSize.h,b=-(0.5*c.sourceSize.w-c.spriteSourceSize.x),g=-(g-c.spriteSourceSize.y));this.defSprite(a,c.frame.x,c.frame.y,c.frame.w,c.frame.h,b,g)}},getStats:function(d){for(var a=0;a<this.sprites.length;a++)if(this.sprites[a].id===d)return this.sprites[a];return null}});function drawSprite(d,a,c,b,g){for(var e in gSpriteSheets){var f=gSpriteSheets[e],h=f.getStats(d);if(null!==h){if(null===f)break;gContext.drawImage(f.img,h.x,h.y,h.w,h.h,a,c,b,g);break}}};var AnimatedEntity=EntityClass.extend({assets:[],numFrames:0,currentFrame:0,frameLength:0,stateTime:0,loop:!1,direction:1,create:function(d,a,c,b,g,e,f){this.parent(d,a,c,b,null);this.assets=g;this.numFrames=g.length;this.frameLength=e/this.numFrames;this.loop=f||!1},update:function(d){this.stateTime+=d;if(this.stateTime>this.frameLength&&(this.stateTime=0,this.currentFrame+=this.direction,this.currentFrame>=this.numFrames||0>this.currentFrame))this.currentFrame-=this.direction,this.direction*=-1,
this.loop||(this._killed=!0)},draw:function(){this.setSprite(this.assets[this.currentFrame]);this.parent()}});gGameEngine.factory.AnimatedEntity=AnimatedEntity;(function(){var d=Class.extend({x:0,y:0,w:100,h:100,cvsHdl:null,ctx:null,create:function(a,c){this.y=this.x=-1;this.w=a;this.h=c;var b=document.createElement("canvas");b.width=a;b.height=c;this.cvsHdl=b;this.ctx=b.getContext("2d")},isVisible:function(){var a=gMap.viewRect;return gMap.intersectRect({top:this.y,left:this.x,bottom:this.y+this.h,right:this.x+this.w},{top:a.y,left:a.x,bottom:a.y+a.h,right:a.x+a.w})}});window.TILEDMapClass=Class.extend({platformBuilder:{newPlatform:!0,size:0,start:{x:0,
y:0},vertical:[]},currMapData:null,tilesets:[],viewRect:{x:0,y:0,w:1E3,h:1E3},numXTiles:100,numYTiles:100,tileSize:{x:64,y:64},pixelSize:{x:64,y:64},imgLoadCount:0,fullyLoaded:!1,canvasTileSize:{x:1024,y:1024},canvasTileArray:[],canvas_width:0,canvas_height:0,load:function(a,c,b,d){gMap.canvas_width=b;gMap.canvas_height=d;xhrGet(a,function(){gMap.parseMapJSON(this.response,c)})},parseMapJSON:function(a,c){gMap.currMapData=JSON.parse(a);var b=gMap.currMapData;gMap.numXTiles=b.width;gMap.numYTiles=
b.height;gMap.tileSize.x=b.tilewidth;gMap.tileSize.y=b.tileheight;gMap.pixelSize.x=gMap.numXTiles*gMap.tileSize.x;gMap.pixelSize.y=gMap.numYTiles*gMap.tileSize.y;for(var d=0;d<b.tilesets.length;d++){var e=new Image;e.onload=function(){gMap.imgLoadCount++;gMap.imgLoadCount===b.tilesets.length&&(gMap.fullyLoaded=!0,c())};var f={firstgid:gMap.currMapData.tilesets[d].firstgid,image:e,imageheight:gMap.currMapData.tilesets[d].imageheight,imagewidth:gMap.currMapData.tilesets[d].imagewidth,name:gMap.currMapData.tilesets[d].name,
margin:gMap.currMapData.tilesets[d].margin,numXTiles:Math.floor(gMap.currMapData.tilesets[d].imagewidth/gMap.tileSize.x),numYTiles:Math.floor(gMap.currMapData.tilesets[d].imageheight/gMap.tileSize.y)};e.src="images/"+b.tilesets[d].image.replace(/^.*[\\\/]/,"");gMap.tilesets.push(f)}},getTilePacket:function(a){for(var c={img:null,px:0,py:0},b=0,b=gMap.tilesets.length-1;0<=b&&!(gMap.tilesets[b].firstgid<=a);b--);c.img=gMap.tilesets[b].image;var d=a-gMap.tilesets[b].firstgid;a=Math.floor(d%gMap.tilesets[b].numXTiles);
d=Math.floor(d/gMap.tilesets[b].numXTiles);c.px=a*gMap.tileSize.x;c.py=d*gMap.tileSize.y;gMap.tilesets[b].margin&&(b=gMap.tilesets[b].margin,c.px+=a*b+b,c.py+=d*b+b);return c},draw:function(a){if(gMap.fullyLoaded)for(var c=0;c<gMap.canvasTileArray.length;c++){var b=gMap.canvasTileArray[c];b.isVisible()&&a.drawImage(b.cvsHdl,b.x-gMap.viewRect.x,b.y-gMap.viewRect.y)}},preDrawCache:function(){for(var a=1+Math.floor(gMap.pixelSize.x/gMap.canvasTileSize.x),c=1+Math.floor(gMap.pixelSize.y/gMap.canvasTileSize.y),
b=0;b<c;b++)for(var g=0;g<a;g++){var e=new d;e.create(gMap.canvasTileSize.x,gMap.canvasTileSize.y);e.x=g*gMap.canvasTileSize.x;e.y=b*gMap.canvasTileSize.y;gMap.canvasTileArray.push(e);gMap.fillCanvasTile(e)}gMap.fullyLoaded=!0},fillCanvasTile:function(a){var c=a.ctx;c.clearRect(0,0,a.w,a.h);a={top:a.y,left:a.x,bottom:a.y+a.h,right:a.x+a.w};for(var b=0;b<gMap.currMapData.layers.length;b++)if("tilelayer"==gMap.currMapData.layers[b].type&&"borders"!==gMap.currMapData.layers[b].name)for(var d=gMap.currMapData.layers[b].data,
e=0;e<d.length;e++){var f=d[e];if(0!==f){var f=gMap.getTilePacket(f),h=Math.floor(e%gMap.numXTiles)*gMap.tileSize.x,k=Math.floor(e/gMap.numXTiles)*gMap.tileSize.y;gMap.intersectRect(a,{top:k,left:h,bottom:k+gMap.tileSize.y,right:h+gMap.tileSize.x})&&c.drawImage(f.img,f.px,f.py,this.tileSize.x,this.tileSize.y,h-a.left,k-a.top,this.tileSize.x,this.tileSize.y)}}},createEntities:function(){for(var a=0,c=0,b=0,d=0,e=0,f=[],b=0;b<gMap.currMapData.layers.length;b++)if("borders"===gMap.currMapData.layers[b].name){f=
gMap.currMapData.layers[b].data;for(d=0;d<f.length;d++)e=f[d],a=Math.floor(d%gMap.numXTiles)*gMap.tileSize.x,c=Math.floor(d/gMap.numXTiles)*gMap.tileSize.y,gMap.buildHorizontalPlatform(e,a,c),2===e?gGameEngine.createGoal(a,c):3===e?gGameEngine.createDynamicEnemy(a,c):4===e?gPlayer.setup(a,c,200,200):5===e?gGameEngine.createStaticEnemy(a,c):6===e&&gMap.platformBuilder.vertical.push({x:a,y:c}),0===(d+1)%gMap.numXTiles&&gMap.buildHorizontalPlatform(-1)}gMap.buildVerticalPlatforms()},buildHorizontalPlatform:function(a,
c,b){gMap.platformBuilder.newPlatform?1===a&&(gMap.platformBuilder.newPlatform=!1,gMap.platformBuilder.size=1,gMap.platformBuilder.start.x=c,gMap.platformBuilder.start.y=b):1!==a?(gGameEngine.createPlatform(gMap.platformBuilder.start.x,gMap.platformBuilder.start.y+6,gMap.tileSize.x*gMap.platformBuilder.size,gMap.tileSize.y-12),gMap.platformBuilder.newPlatform=!0):gMap.platformBuilder.size+=1},buildVerticalPlatforms:function(){var a=[],c={};gMap.platformBuilder.vertical.forEach(function(b){-1===a.indexOf(b.x)&&
(a.push(b.x),c[b.x]=[]);c[b.x].push(b)});a.forEach(function(a){c[a].sort(function(a,b){return a.y===b.y?0:a.y<b.y?-1:1});a=c[a];var d=a.length;gMap.platformBuilder.size=1;gMap.platformBuilder.start.x=a[0].x;gMap.platformBuilder.start.y=a[0].y;for(var e=1;e<d;e++)e+1===d?(gMap.platformBuilder.size+=1,gGameEngine.createPlatform(gMap.platformBuilder.start.x+5,gMap.platformBuilder.start.y+12,gMap.tileSize.x-10,gMap.tileSize.y*gMap.platformBuilder.size)):a[e].y!==a[e-1].y+gMap.tileSize.y?(gGameEngine.createPlatform(gMap.platformBuilder.start.x+
5,gMap.platformBuilder.start.y+12,gMap.tileSize.x-10,gMap.tileSize.y*gMap.platformBuilder.size),gMap.platformBuilder.size=1,gMap.platformBuilder.start.x=a[e].x,gMap.platformBuilder.start.y=a[e].y):gMap.platformBuilder.size+=1})},intersectRect:function(a,c){return!(c.left>a.right||c.right<a.left||c.top>a.bottom||c.bottom<a.top)},centerAt:function(a,c){gMap.viewRect.x=a-gMap.canvas_width/2;0>gMap.viewRect.x?gMap.viewRect.x=0:gMap.viewRect.x+gMap.canvas_width>gMap.pixelSize.x&&(gMap.viewRect.x=gMap.pixelSize.x-
gMap.canvas_width);gMap.viewRect.y=c-gMap.canvas_height/2;0>gMap.viewRect.y?gMap.viewRect.y=0:gMap.viewRect.y+gMap.canvas_height>gMap.pixelSize.y&&(gMap.viewRect.y=gMap.pixelSize.y-gMap.canvas_height)}});window.gMap=new TILEDMapClass}).call(this);var EnemyEntity=AnimatedEntity.extend({zindex:2,physBody:null,newPos:{x:0,y:0},dynamic:!1,startAnim:0,currentTime:0,currVel:null,create:function(d,a,c,b,g,e,f){(this.dynamic=f)?(this.parent(d,a,c,b,g,e,!0),this.startAnim=100*Math.random(),this.physBody=gPhysicsEngine.addBody({x:d,y:a,type:"dynamic",density:1,friction:0.5,restitution:0.7,radius:50,userData:{id:"enemy",ent:this}})):(this.parent(d,a+2,c,b,g,e,!0),this.startAnim=300*Math.random(),this.physBody=gPhysicsEngine.addBody({x:d,y:a+2,halfWidth:c/
2-34,halfHeight:b/2-25,type:"static",density:1,friction:0.5,restitution:0.7,userData:{id:"enemy",ent:this}}))},update:function(d){this.dynamic&&(this.newPos=this.physBody.GetPosition(),this.currVel=this.physBody.GetLinearVelocity(),this.position(this.newPos.x*gPhysicsEngine.scale,this.newPos.y*gPhysicsEngine.scale),0.4>this.currVel.y&&this.physBody.ApplyImpulse({x:0,y:-0.4},this.newPos));this.currentTime+=d;this.currentTime>=this.startAnim&&(this.parent(d),0===this.currentFrame&&(this.currentTime=
0))},kill:function(){gPhysicsEngine.removeBody(this.physBody)}});gGameEngine.factory.EnemyEntity=EnemyEntity;(function(){var d=Class.extend({image:"",setup:function(a){this.image=a},draw:function(){gContext.drawImage(gCachedAssets[this.image],0,0,gCanvas.width,gCanvas.height)}});window.gBackground=new d}).call(this);var GoalEntity=AnimatedEntity.extend({zindex:2,physBody:null,create:function(d,a,c,b,g,e){this.parent(d,a,c,b,g,e,!0);this.physBody=gPhysicsEngine.addBody({x:d,y:a,type:"static",radius:32,userData:{id:"goal",ent:this}})}});gGameEngine.factory.GoalEntity=GoalEntity;var PlatformEntity=EntityClass.extend({zindex:1,physBody:null,newPos:{x:0,y:0},create:function(d,a,c,b,g,e){e=c/2;var f=b/2;this.parent(d+e,a+f,c,b,g);this.physBody=gPhysicsEngine.addBody({halfWidth:e,halfHeight:f,x:d+e,y:a+f,type:"static",userData:{id:"platform",ent:this}})},draw:function(){},onTouch:function(d,a){},update:function(d){},kill:function(){gPhysicsEngine.removeBody(this.physBody)}});gGameEngine.factory.PlatformEntity=PlatformEntity;(function(){var d=Class.extend({startPos:{x:0,y:0},pos:{x:0,y:0},forcePos:null,newpos:{x:0,y:0},canvaspos:{x:0,y:0},size:{x:0,y:0},halfsize:{x:0,y:0},stateTime:0,physBody:null,readyToJump:!1,jumpStrength:100,jumpVec:{x:0,y:-1},oldJumpVec:{x:0,y:0},speed:8,maxSpeed:24,currVel:null,antiForce:0,onWall:!1,onCeiling:!1,walkRight:["creamywalk01.png","creamywalk02.png"],walkLeft:["creamywalk01L.png","creamywalk02L.png"],walkJumpRight:["creamywalk04.png","creamywalk05.png"],walkJumpLeft:["creamywalk04L.png",
"creamywalk05L.png"],ceilingRight:["creamyhang05.png","creamyhang04.png"],ceilingLeft:["creamyhang05L.png","creamyhang04L.png"],ceilingJumpR:["creamywalk05.png","creamywalk05.png"],ceilingJumpL:["creamywalk05L.png","creamywalk05L.png"],stand:["creamyjump01.png","creamyjump01.png"],standJump:["creamyjump00.png","creamyjump03.png"],wallWalkRight:["creamywall01.png","creamywall03.png"],wallWalkLeft:["creamywall01L.png","creamywall03L.png"],currentFrame:0,updateTime:100,animTime:0,animDir:1,jumper:!1,
dirX:1,dirY:1,currentAnimation:null,setup:function(a,c,b,d){this.startPos.x=a;this.startPos.y=c;this.size.x=b;this.size.y=d;this.halfsize.x=b/2;this.halfsize.y=d/2;this.currentAnimation=this.stand;this.physBody=gPhysicsEngine.addBody({x:a,y:c,type:"dynamic",density:0.6,friction:1,restitution:-200,radius:b/2,userData:{id:"player",ent:this}});this.antiForce=gPhysicsEngine.gravity.y*this.physBody.GetMass()/20},draw:function(){this.convertPosToScreen();drawSprite(this.currentAnimation[this.currentFrame],
this.canvaspos.x-this.halfsize.x,this.canvaspos.y-this.halfsize.y,this.size.x,this.size.y)},update:function(a){this.newpos.y>gMap.pixelSize.y&&(this.forcePos={x:this.startPos.x,y:this.startPos.y});this.forcePos&&(this.physBody.SetPosition(new Vec2(this.forcePos.x/gPhysicsEngine.scale,this.forcePos.y/gPhysicsEngine.scale)),this.forcePos=null);this.pos=this.physBody.GetPosition();this.currVel=this.physBody.GetLinearVelocity();this.onCeiling&&this.physBody.ApplyForce({x:0,y:-(8*this.antiForce)},this.physBody.GetWorldCenter());
this.stateTime+=a;16<this.stateTime&&(this.stateTime=0,!0===this.readyToJump?(this.onWall&&this.physBody.ApplyForce({x:0,y:-this.antiForce},this.physBody.GetWorldCenter()),this.setWalkAnimation(),this.updatePlayerInput()):0===this.jumpVec.x?this.onWall=!1:0>=this.jumpVec.x&&(this.onCeiling=!1));this.newpos.x=this.pos.x*gPhysicsEngine.scale;this.newpos.y=this.pos.y*gPhysicsEngine.scale;gMap.centerAt(this.newpos.x,this.newpos.y,600,1E3);this.oldJumpVec.x=this.jumpVec.x;this.oldJumpVec.y=this.jumpVec.y;
this.updateAnimations(a)},updatePlayerInput:function(){gInputEngine.actions.jump&&this.readyToJump&&(this.physBody.ApplyImpulse(this.jumpVec,this.pos),this.setJumpAnimation(),this.jumpVec.x=0,this.jumpVec.y=0,this.onCeiling=this.readyToJump=!1);!0===this.readyToJump&&(gInputEngine.actions["move-right"]&&this.currVel.x<this.maxSpeed&&(0===this.jumpVec.x?this.physBody.ApplyImpulse({x:this.speed,y:0},this.pos):0<this.jumpVec.x?this.physBody.ApplyImpulse({x:0,y:this.speed},this.pos):this.physBody.ApplyImpulse({x:0,
y:-this.speed},this.pos)),gInputEngine.actions["move-left"]&&this.currVel.x>-this.maxSpeed&&(0===this.jumpVec.x?this.physBody.ApplyImpulse({x:-this.speed,y:0},this.pos):0<this.jumpVec.x?this.physBody.ApplyImpulse({x:0,y:-this.speed},this.pos):this.physBody.ApplyImpulse({x:0,y:this.speed},this.pos)))},onTouch:function(a,c,b){this.physBody&&a.GetUserData()&&(a=a.GetUserData(),a.ent&&!a.ent._killed&&("platform"===a.id?(this.readyToJump=!0,b=b.GetManifold().m_localPlaneNormal,this.jumpVec={x:b.x*this.jumpStrength,
y:b.y*this.jumpStrength},0!==this.jumpVec.x&&!1===this.onWall?(this.onWall=!0,this.physBody.SetLinearVelocity(new Vec2(0,0))):0<this.jumpVec.y&&!1===this.onCeiling&&(this.onCeiling=!0)):"enemy"===a.id?(this.forcePos={x:this.startPos.x,y:this.startPos.y},this.physBody.SetLinearVelocity(new Vec2(0,0)),this.currentAnimation=this.stand,gSM.playSound("sound/hit.ogg")):"goal"===a.id&&(gGameEngine.gameState=gGameEngine.STATE.WIN,gSM.playSound("sound/coin.ogg"))))},onEndContact:function(){this.jumpVec.x=
0;this.jumpVec.y=0;this.readyToJump=!1},updateAnimations:function(a){if(0.8<this.currVel.x||-0.8>this.currVel.x||0.8<this.currVel.y||-0.8>this.currVel.y){this.animTime+=a;if(this.animTime>this.updateTime&&(this.animTime=0,this.currentFrame+=this.animDir,this.jumper&&(this.currentFrame=1),this.currentFrame>=this.currentAnimation.length||0>this.currentFrame))this.currentFrame-=this.animDir,this.animDir*=-1;this.oldJumpVec.x!==this.jumpVec.x&&this.oldJumpVec.y!==this.jumpVec.y&&this.setWalkAnimation()}else 0>
this.jumpVec.y&&(this.currentAnimation=this.stand)},setJumpAnimation:function(){this.currentAnimation=0>this.jumpVec.y&&0<this.currVel.x?this.walkJumpRight:0>this.jumpVec.y&&0>this.currVel.x?this.walkJumpLeft:0<this.jumpVec.y&&0<this.currVel.x?this.ceilingJumpR:0<this.jumpVec.y&&0>this.currVel.x?this.ceilingJumpL:0<this.jumpVec.x?this.ceilingJumpR:0>this.jumpVec.x?this.ceilingJumpL:this.standJump;this.jumper=!0},setWalkAnimation:function(){0>this.jumpVec.x?(this.currentAnimation=this.wallWalkRight,
this.jumper=!1):0<this.jumpVec.x?(this.currentAnimation=this.wallWalkLeft,this.jumper=!1):0>this.jumpVec.y&&0<this.currVel.x?(this.currentAnimation=this.walkRight,this.jumper=!1):0>this.jumpVec.y&&0>this.currVel.x?(this.currentAnimation=this.walkLeft,this.jumper=!1):0<this.jumpVec.y&&0<this.currVel.x?(this.currentAnimation=this.ceilingRight,this.jumper=!1):0<this.jumpVec.y&&0>this.currVel.x&&(this.currentAnimation=this.ceilingLeft,this.jumper=!1)},convertPosToScreen:function(){this.canvaspos.x=this.newpos.x-
gMap.viewRect.x;this.canvaspos.y=this.newpos.y-gMap.viewRect.y}});window.gPlayer=new d}).call(this);(function(){function d(){gLoading.style.position="fixed";gLoading.style.top="45%";var a=setInterval(function(){gLoading.style.top=parseInt(gLoading.style.top,10)+1+"%";70<parseInt(gLoading.style.top,10)&&clearInterval(a)},10)}window.gLoading=null;window.gCanvas=null;window.gContext=null;var a=["images/controls.png","images/doneloading.png","images/winner.png"];window.onload=function(){loadAssets(a,function(){var a=document.getElementById("soundcontrol"),b=document.getElementById("screenshot");gLoading=
document.getElementById("loading");gCanvas=document.getElementById("game");gContext=gCanvas.getContext("2d");d(gLoading,20);gContext.drawImage(gCachedAssets["images/controls.png"],0,0);gSM.setup();a.addEventListener("click",function(b){b.preventDefault();gSM.togglemute();a.style.textDecoration="line-through"===a.style.textDecoration?"none":"line-through"});b.addEventListener("click",function(a){a.preventDefault();window.open(gCanvas.toDataURL(),"screen shot")});gSM.loadAsync("sound/music.mp3",function(){gSM.playSound("sound/music.mp3",
{looping:!0})});gGameEngine.setup()})}}).call(this);
